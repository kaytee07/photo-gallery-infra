AWSTemplateFormatVersion: '2010-09-09'
Description: Private S3 Buckets for ECS Photo Gallery App

Parameters:
  BucketName:
    Type: String
    Description: Unique name for the S3 bucket
    Default: photo-gallery-bucket-unique-images

Resources:
  ArtifactBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: first-photo-gallery-artifacts
      VersioningConfiguration:
        Status: Enabled
    DeletionPolicy: Retain

  ImageBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref BucketName
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced

  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ImageBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Allow ECS task role access
          - Effect: Allow
            Principal:
              AWS: !ImportValue PhotoGalleryEcsTaskRoleArn
            Action:
              - s3:PutObject
              - s3:PutObjectAcl
              - s3:PutObjectTagging
              - s3:GetObject
              - s3:ListBucket
            Resource:
              - !Sub arn:aws:s3:::${ImageBucket}
              - !Sub arn:aws:s3:::${ImageBucket}/*

          # Enforce HTTPS
          - Effect: Deny
            Principal: '*'
            Action: s3:*
            Resource:
              - !Sub arn:aws:s3:::${ImageBucket}
              - !Sub arn:aws:s3:::${ImageBucket}/*
            Condition:
              Bool:
                aws:SecureTransport: false
          
          # Allow CloudFront OAI access
          - Effect: Allow
            Principal:
              CanonicalUser: !GetAtt CloudFrontOAI.S3CanonicalUserId
            Action: s3:GetObject
            Resource: !Sub arn:aws:s3:::${ImageBucket}/*

          # Allow CloudFormation service role to clean up bucket
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: s3:*
            Resource:
              - !Sub arn:aws:s3:::${ImageBucket}
              - !Sub arn:aws:s3:::${ImageBucket}/*

Outputs:
  BucketName:
    Value: !Ref ImageBucket
    Export:
      Name: PhotoGalleryStorageBucketName

  ArtifactBucketName:
    Value: !Ref ArtifactBucket
    Export:
      Name: PhotoGalleryArtifactBucketName

  ImageBucketArn:
    Value: !GetAtt ImageBucket.Arn
    Export:
      Name: PhotoGalleryImageBucketArn


